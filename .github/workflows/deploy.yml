name: Deploy via SSH over Cloudflare Tunnel

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install cloudflared
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
        chmod +x cloudflared
        sudo mv cloudflared /usr/local/bin/

    - name: Start Cloudflare SSH tunnel
      run: |
        cloudflared access tcp --hostname ssh.nurahsanadzim.com --url localhost:2222 &
        sleep 5  # give it time to connect

    - name: SSH and deploy
      env:
        WSL_KEY: ${{ secrets.WSL_KEY }}
      run: |
        echo "$WSL_KEY" > key.pem
        chmod 600 key.pem
        ssh -o StrictHostKeyChecking=no -i key.pem -p 2222 ubuntu@localhost "echo 'âœ… SSH Successful!'; hostname"
